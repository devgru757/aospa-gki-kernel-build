name: Build Kernel (No SU)

on:
  workflow_dispatch:

env:
  CLANG_DIR: clang-r584948
  # CI Optimization
  LTO: thin

permissions:
  contents: write

jobs:
  build-kernel-nosu:
    runs-on: ubuntu-22.04
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      - name: Set Swap Space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 16

      - name: Setup Build Structure
        run: |
          # Structure based on build.sh and .build.rc (SRC_ROOT=../..)
          # workspace/                  <-- KP_ROOT / SRC_ROOT
          # ├── clang/
          # ├── prebuilts/
          # └── device/xiaomi/
          #     ├── marble-kernel/      <-- Kernel Source (pwd)
          #     ├── sm8450-modules/     <-- ../sm8450-modules
          #     └── sm8450-devicetrees/ <-- ../sm8450-devicetrees
          
          mkdir -p workspace/device/xiaomi
          mkdir -p workspace/clang
          mkdir -p workspace/prebuilts/kernel-build-tools

      - name: Setup Python
        uses: actions/setup-python@v5 
        with:
          python-version: '3.10'

      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y bc device-tree-compiler bison flex libssl-dev git zip
          # Install repo tool
          sudo curl --create-dirs -o /usr/local/bin/repo -L https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod a+rx /usr/local/bin/repo

      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          path: temp_source

      - name: Organize Source Code
        run: |
          # Move the specific kernel folder to the location build.sh expects
          mv temp_source/android_kernel_xiaomi_sm8450 workspace/device/xiaomi/marble-kernel
          rm -rf temp_source

      - name: Clone Dependencies
        run: |
          cd workspace/device/xiaomi
          
          # 1. Modules (Sibling to marble-kernel as per ../$MODULES_REPO)
          git clone --depth=1 https://github.com/LineageOS/android_kernel_xiaomi_sm8450-modules sm8450-modules
          
          # 2. Devicetrees (Sibling to marble-kernel as per ../$DT_REPO)
          git clone --depth=1 https://github.com/LineageOS/android_kernel_xiaomi_sm8450-devicetrees sm8450-devicetrees

          # 3. Prebuilts (At Root)
          cd ../..
          git clone --depth=1 https://android.googlesource.com/kernel/prebuilts/build-tools prebuilts/kernel-build-tools

      - name: Setup Clang
        run: |
          cd workspace/clang
          # Download specific Clang version
          git clone -n --depth=1 --filter=tree:0 -b main-kernel --single-branch \
              https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 .
          git sparse-checkout set --no-cone "/$CLANG_DIR"
          git checkout
          
          # Create symlink so build.sh finds it at $KP_ROOT/clang/$CLANG_DIR
          # (Since we downloaded INTO workspace/clang, the folder is workspace/clang/$CLANG_DIR)

      - name: Scrub KSU (Deep Clean)
        run: |
          cd workspace/device/xiaomi/marble-kernel
          
          echo "Removing KernelSU configurations..."
          
          # 1. Remove KSU from Makefiles/Kconfig
          sed -i '/kernelsu\/Kconfig/d' drivers/Kconfig || true
          sed -i '/kernelsu/d' drivers/Makefile || true
          sed -i '/CONFIG_KSU/d' drivers/Makefile || true

          # 2. Remove KSU from ALL configs (Vendor, Personal, GKI)
          find arch/arm64/configs -type f -name "*.config" -exec sed -i '/CONFIG_KSU/d' {} +
          
          # 3. Remove KSU hooks from source code to prevent linker errors
          grep -rl "drivers/kernelsu/ksu.h" . | xargs sed -i '/drivers\/kernelsu\/ksu.h/d' || true
          grep -rl "ksu_handle" fs/ drivers/input/ | xargs sed -i '/ksu_handle/d' || true

      - name: Build Kernel
        run: |
          cd workspace/device/xiaomi/marble-kernel
          
          # Ensure build script is executable
          chmod +x build.sh
          
          # Run build script
          ./build.sh marble

      - name: Package Artifacts
        run: |
          cd workspace/device/xiaomi/marble-kernel
          
          mkdir -p release_pack
          cd release_pack
          
          # Use AnyKernel3 to package
          git clone --depth=1 -b marble https://github.com/bryanyee33/AnyKernel3.git .
          rm -rf .git README.md
          
          # Copy artifacts (build.sh puts them in kernel root or out/dist, we check both)
          if [ -f "../out/arch/arm64/boot/Image" ]; then
             cp ../out/arch/arm64/boot/Image .
          elif [ -f "../Image" ]; then
             cp ../Image .
          fi
          
          # Copy DTBO
          if [ -f "../out/dtbs/dtbo.img" ]; then
             cp ../out/dtbs/dtbo.img .
          elif [ -f "../dtbo.img" ]; then
             cp ../dtbo.img .
          fi

          # Copy Modules (Vendor DLKM / Ramdisk)
          # build.sh often copies these to specific dirs in kernel root
          [ -d "../vendor_dlkm" ] && cp -r ../vendor_dlkm/* .
          [ -d "../vendor_ramdisk" ] && cp -r ../vendor_ramdisk/* .
          
          # Zip it up
          zip -r9 "../marble-kernel-nosu.zip" *

      - name: Generate Release Tag
        id: tag
        run: echo "release_tag=Marble_NoSU_$(date +'%Y.%m.%d')" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          files: |
            workspace/device/xiaomi/marble-kernel/marble-kernel-nosu.zip
